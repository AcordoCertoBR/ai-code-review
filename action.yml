$schema: "https://json.schemastore.org/github-action.json"
name: "OpenAI Code Review Action"
description: "Executa um code review usando a API da OpenAI e posta comentários no PR se houver problemas críticos."
runs:
  using: "composite"
  steps:
    - name: Obter diff do Pull Request
      id: get_diff
      shell: bash
      run: |
        BASE_REF="${{ github.event.pull_request.base.ref }}"
        git fetch origin "$BASE_REF" --depth=1
        DIFF=$(git diff origin/"$BASE_REF" HEAD)
        echo "Diff obtido:"
        echo "$DIFF"
        # Salva o diff no output usando o GITHUB_OUTPUT
        echo "diff<<EOF" >> "$GITHUB_OUTPUT"
        echo "$DIFF" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"

    - name: Set GitHub Action Path
      shell: bash
      run: echo "$GITHUB_ACTION_PATH" >> "$GITHUB_PATH"
      env:
        GITHUB_ACTION_PATH: ${{ github.action_path }}

    - name: Executar Code Review com OpenAI
      id: code_review
      shell: bash
      run: |
        # Salva o diff no arquivo fixo "diff.txt" usando printf para preservar a formatação
        printf '%s\n' "${{ steps.get_diff.outputs.diff }}" > diff.txt
        # Executa o script code_review.py utilizando o caminho absoluto definido pela variável GITHUB_ACTION_PATH
        python3 "$GITHUB_ACTION_PATH/code_review.py" diff.txt
